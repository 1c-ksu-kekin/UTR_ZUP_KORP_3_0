
#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ЮТР_ПриОткрытии(Отказ)
	
	//ЮТР начало изменения 
	//{32 539}, 10.03.2015
	//выводится сообщение количества дней пребвания за границей

	ЮТР_УстановитьВидимостьСообщения();
	
	//ЮТР окончание изменения
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийТаблицыФормыТрудоваяДеятельностьфизическихлиц

#КонецОбласти

#Область ОбработчикиКомандФормы


#КонецОбласти

#Область ОбработчикиЭлементовФормы

&НаКлиенте
Процедура ЮТР_СтатусФизическихЛицКакНалогоплательщиковНДФЛСтатусПриИзменении(Элемент)
	
	УстановитьВыполнениеПослеОбработчиковСобытия("ЮТР_СтатусФизическихЛицКакНалогоплательщиковНДФЛСтатусПриИзмененииПосле", Неопределено);
	
КонецПроцедуры

&НаКлиенте
Процедура ЮТР_СтатусФизическихЛицКакНалогоплательщиковНДФЛСтатусПриИзмененииПосле(Элемент, ДополнительныеДанные)
	
	//ЮТР начало изменения 
	//{32 539}, 10.03.2015
	//<краткое описания причины изменения>

	ЮТР_УстановитьВидимостьСообщения();
	
	//ЮТР окончание изменения

	
КонецПроцедуры

#КонецОбласти


#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура ЮТР_УстановитьВидимостьСообщения()
	
	КоличествоДнейНерезидента = 0;
	СтруктураПараметров = Новый Структура();
	СтруктураПараметров.Вставить("Сотрудник", ФизическоеЛицоСсылка);
	СтруктураПараметров.Вставить("Организация", ТекущаяОрганизация);
	
	Статус = СтатусФизическихЛицКакНалогоплательщиковНДФЛ.Статус;
	
	Структура = ЮТР_ПолучитьОсновнойСтатус();
	
	Если ЗначениеЗаполнено(Структура.Статус) Тогда
		ОсновнойСтатус = Структура.Статус;
		ОсновнойПериод = Структура.Период;
	Иначе
		ОсновнойСтатус = ПредопределенноеЗначение("Справочник.СтатусыНалогоплательщиковПоНДФЛ.Резидент");
		ОсновнойПериод = Дата("1,1,1");
	КонецЕсли;
		
	КоличествоДней = ЮТР_КадровыйУчет.УстановитьВидимостьСообщенияСервер(СтруктураПараметров);
	
	Если ОсновнойСтатус = ПредопределенноеЗначение("Справочник.СтатусыНалогоплательщиковПоНДФЛ.Нерезидент") Тогда
		КоличествоДнейНерезидента = (НачалоДня(ТекущаяДата()) - Макс(НачалоДня(ОсновнойПериод), ДобавитьМесяц(НачалоДня(ТекущаяДата()), - 12) + 86400))/86400 + 1 - КоличествоДней;
	КонецЕсли;
	
	Если КоличествоДней > 183 И Статус = ПредопределенноеЗначение("Справочник.СтатусыНалогоплательщиковПоНДФЛ.Резидент") И ОсновнойСтатус = ПредопределенноеЗначение("Справочник.СтатусыНалогоплательщиковПоНДФЛ.Резидент")
		ИЛИ КоличествоДней < 183 И Статус = ПредопределенноеЗначение("Справочник.СтатусыНалогоплательщиковПоНДФЛ.Нерезидент") И ОсновнойСтатус = ПредопределенноеЗначение("Справочник.СтатусыНалогоплательщиковПоНДФЛ.Резидент")
		ИЛИ КоличествоДнейНерезидента > 183 И ОсновнойСтатус = ПредопределенноеЗначение("Справочник.СтатусыНалогоплательщиковПоНДФЛ.Нерезидент") И НЕ Статус = ПредопределенноеЗначение("Справочник.СтатусыНалогоплательщиковПоНДФЛ.Резидент")
		ИЛИ КоличествоДнейНерезидента <= 183 И ОсновнойСтатус = ПредопределенноеЗначение("Справочник.СтатусыНалогоплательщиковПоНДФЛ.Нерезидент") И Статус = ПредопределенноеЗначение("Справочник.СтатусыНалогоплательщиковПоНДФЛ.Резидент") Тогда
		
		ЦветКнопки = Новый Цвет(255, 0, 0);
		
	Иначе
		
		ЦветКнопки = Новый Цвет(0, 0, 0);
		
	КонецЕсли;
	
	Элементы.ЮТР_ИнформационноеСообщение.ЦветТекстаЗаголовка = ЦветКнопки;
	Элементы.ЮТР_ИнформационноеСообщение.ЦветТекста = ЦветКнопки ;
	
	Если ОсновнойСтатус = ПредопределенноеЗначение("Справочник.СтатусыНалогоплательщиковПоНДФЛ.Нерезидент") Тогда
		ЮТР_ИнформационноеСообщение = "У сотрудника " + СотрудникСсылка + " количество дней пребывание в России равно " + КоличествоДнейНерезидента;
	Иначе
		ЮТР_ИнформационноеСообщение = "У сотрудника " + СотрудникСсылка + " количество дней пребывания за границей равно " + КоличествоДней;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ЮТР_ПолучитьОсновнойСтатус()
	
	Структура = Новый Структура("Статус, Период");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СтатусФизическихЛицКакНалогоплательщиковНДФЛ.Период КАК Период,
		|	СтатусФизическихЛицКакНалогоплательщиковНДФЛ.ФизическоеЛицо КАК ФизическоеЛицо,
		|	СтатусФизическихЛицКакНалогоплательщиковНДФЛ.Статус КАК Статус
		|ПОМЕСТИТЬ СтатусыФизЛица
		|ИЗ
		|	РегистрСведений.СтатусФизическихЛицКакНалогоплательщиковНДФЛ КАК СтатусФизическихЛицКакНалогоплательщиковНДФЛ
		|ГДЕ
		|	СтатусФизическихЛицКакНалогоплательщиковНДФЛ.ФизическоеЛицо = &ФизическоеЛицо
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	МИНИМУМ(СтатусыФизЛица.Период) КАК Период,
		|	СтатусыФизЛица.ФизическоеЛицо КАК ФизическоеЛицо
		|ПОМЕСТИТЬ МинимальныйПериод
		|ИЗ
		|	СтатусыФизЛица КАК СтатусыФизЛица
		|
		|СГРУППИРОВАТЬ ПО
		|	СтатусыФизЛица.ФизическоеЛицо
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	МинимальныйПериод.Период,
		|	СтатусыФизЛица.ФизическоеЛицо,
		|	СтатусыФизЛица.Статус
		|ИЗ
		|	МинимальныйПериод КАК МинимальныйПериод
		|		ЛЕВОЕ СОЕДИНЕНИЕ СтатусыФизЛица КАК СтатусыФизЛица
		|		ПО СтатусыФизЛица.ФизическоеЛицо = МинимальныйПериод.ФизическоеЛицо
		|			И СтатусыФизЛица.Период = МинимальныйПериод.Период";
		
	Запрос.УстановитьПараметр("ФизическоеЛицо", ФизическоеЛицоСсылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	Если Не РезультатЗапроса.Пустой() Тогда
		Выборка = РезультатЗапроса.Выбрать();
		Выборка.Следующий();
		
		Структура.Статус = Выборка.Статус;
		Структура.Период = Выборка.Период;
	КонецЕсли;
	
	Возврат Структура;
	
КонецФункции

#КонецОбласти





