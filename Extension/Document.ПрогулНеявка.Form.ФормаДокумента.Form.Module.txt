
&НаКлиенте
Процедура ЮТР_СостояниеСлужебныйПриИзменении(Элемент)
	
	УстановитьСостояниеДокумента();
	
	ЮТР_УстановитьОтборНачислений();
			
	ВыполнитьРасчетНачислений();
	
КонецПроцедуры

&НаСервере
Процедура ЮТР_ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	УстановитьВыполнениеПослеОбработчиковСобытия("ЮТР_ПриСозданииНаСервереПосле", Неопределено);
		
КонецПроцедуры

&НаСервере
Процедура ЮТР_ПриСозданииНаСервереПосле(Отказ, СтандартнаяОбработка, ДополнительныйПараметр)
	
	ВидРасчетаОтсутствия = Объект.ВидОтсутствия;
	ВидСостоянияОтсутствия = Объект.СостояниеСотрудника;
	
	Если ВидСостоянияОтсутствия = ПредопределенноеЗначение("Перечисление.СостоянияСотрудника.Прогул") Тогда
		
		Этаформа.СостояниеСлужебный	= 2;
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "ВидОтсутствия", "Доступность", Ложь);
		
	ИначеЕсли ВидСостоянияОтсутствия = ПредопределенноеЗначение("Перечисление.СостоянияСотрудника.ОтсутствиеПоНевыясненнымПричинам") И 
		ВидРасчетаОтсутствия = ПредопределенноеЗначение("ПланВидовРасчета.Начисления.ОтсутствиеПоНевыясненнойПричинеБолезнь") Тогда
		
		Этаформа.СостояниеСлужебный	= 1;
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "ВидОтсутствия", "Доступность", Ложь);
		
	Иначе
		
		Этаформа.СостояниеСлужебный	= 0;
		
	КонецЕсли; 
	
КонецПроцедуры	

&НаСервере
Процедура УстановитьОтборНачисленийДополнительный()

	ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "ВидОтсутствия", "Доступность", Ложь);
	
	Если ЭтаФорма.СостояниеСлужебный = 0 Тогда
		Объект.ВидОтсутствия = ПредопределенноеЗначение("ПланВидовРасчета.Начисления.ОтсутствиеПоНевыясненнойПричине");
	Иначе
		Объект.ВидОтсутствия = ПредопределенноеЗначение("ПланВидовРасчета.Начисления.ОтсутствиеПоНевыясненнойПричинеБолезнь");
	КонецЕсли; 
	
КонецПроцедуры

&НаСервере
Процедура УстановитьСостояниеДокумента()
	
	Если Этаформа.СостояниеСлужебный = 2 Тогда
		
		Объект.СостояниеСотрудника = ПредопределенноеЗначение("Перечисление.СостоянияСотрудника.Прогул");
		
	Иначе
		
		Объект.СостояниеСотрудника = ПредопределенноеЗначение("Перечисление.СостоянияСотрудника.ОтсутствиеПоНевыясненнымПричинам");
		
	КонецЕсли; 

КонецПроцедуры

&НаСервере
Процедура ЮТР_УстановитьОтборНачислений()
	
	УстановитьПривилегированныйРежим(Истина);
	
	// Изменить параметры выбора начисления.
	ОтборНачислений = ОтборНачислений();
	УстановитьПараметрыВыбораВидаОтсутствия(ОтборНачислений);
	
	НачисленияПоСостоянию = ПланыВидовРасчета.Начисления.НачисленияПоОтбору(ОтборНачислений);
	Если НачисленияПоСостоянию.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Если Объект.СостояниеСотрудника = ПредопределенноеЗначение("Перечисление.СостоянияСотрудника.ОтсутствиеПоНевыясненнымПричинам") 
		И (НЕ Объект.ОтсутствиеВТечениеЧастиСмены) Тогда
		
		УстановитьОтборНачисленийДополнительный();	
		
	Иначе	
		
		// Если такое начисление единственное запретить выбор.
		ОбщегоНазначенияКлиентСервер.УстановитьСвойствоЭлементаФормы(Элементы, "ВидОтсутствия", "Доступность", НачисленияПоСостоянию.Количество() > 1);
		
		Если НачисленияПоСостоянию.Найти(Объект.ВидОтсутствия) <> Неопределено Тогда
			 //Выбранный вид отсутствия есть в списке начислений, не нужно ничего изменять.
			Возврат;
		КонецЕсли;
		
		// Если установленное начисление не подходит, подобрать другое первое попавшееся под новые параметры.
		Объект.ВидОтсутствия = НачисленияПоСостоянию[0];
		
	КонецЕсли;
	
	// Т.к. начисление было изменено, нужно запустить соответствующую обработку.
	ВидОтсутствияПриИзмененииНаСервере();
	
КонецПроцедуры


 